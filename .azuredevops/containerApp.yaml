type: Microsoft.App/containerApps
identity:
  type: 'UserAssigned'
  userAssignedIdentities: {
     {{userAssignedIdentity}}
  }
properties:
  managedEnvironmentId: {{managedEnvironmentId}}
  configuration:
    ingress:
      external: false
      allowInsecure: false
      targetPort: 8080
      traffic:
        - latestRevision: true
          weight: 100
      transport: Auto
    registries:
      - server: {{acrName}}.azurecr.io
        identity: {{userAssignedIdentity}}
    secrets:
      - name: ado-pat
        keyVaultUrl: https://{{keyvaultName}}.vault.azure.net/secrets/ADO-PAT
        identity: {{userAssignedIdentity}}
      - name: clientsecret
        keyVaultUrl: https://{{keyvaultName}}.vault.azure.net/secrets/adp-portal-api-ClientSecret
        identity: {{userAssignedIdentity}}
  template:
    containers:
      - image: {{acrName}}.azurecr.io/image/{{imageRepoName}}:{{appVersion}}
        name: {{imageRepoName}}
        env:
          - name: ASPNETCORE_ENVIRONMENT
            value: "Development"
          - name: Logging__LogLevel__Default
            value: "Information"
          - name: Logging__LogLevel__Microsoft.AspNetCore
            value: "Warning"
          - name: AdpAdoProject__Name
            value: "DEFRA-FFC"
          - name: Ado__OrganizationUrl
            value: "https://dev.azure.com/defragovuk"
          - name: Ado__UsePatToken
            value: true
          - name: Ado__PatToken
            secretRef: ado-pat

          # - name: OpenVPN__TenantId
          #   value: {{tenantid}}            
          # - name: OpenVPN__ClientId
          #   value: {{clientid}}
          # - name: OpenVPN__ClientSecret
          #   secretRef: clientsecret
          # - name: OpenVPN__GroupId
          #   value: {{groupid}}
          # - name: OpenVPN__Instance
          #   value: {{instance}}    
          # - name: OpenVPN__GraphResource
          #   value: {{graphresource}}    
          # - name: OpenVPN__GraphResourceEndPoint
          #   value: {{graphendpoint}}  

          - name: OpenVPN__TenantId
            value: "6f504113-6b64-43f2-ade9-242e05780007"            
          - name: OpenVPN__ClientId
            value: "03ba3c8f-5086-45e0-870c-7fbd689c262e"
          - name: OpenVPN__ClientSecret
            value: "UE~8Q~OV5Hw-U_thwdNdswsOqEngVG7kZnoa9az0"
          - name: OpenVPN__GroupId
            value: "004decd6-767b-417a-9223-a32dcbaa6b00"
          - name: OpenVPN__Instance
            value: "https://login.microsoftonline.com/"    
          - name: OpenVPN__GraphResource
            value: "https://graph.microsoft.com/"    
          - name: OpenVPN__GraphResourceEndPoint
            value: "v1.0"

        resources:
          cpu: 0.5
          memory: 1Gi
    scale:
      minReplicas: 1
      maxReplicas: 3  